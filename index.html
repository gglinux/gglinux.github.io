<!doctype html>



  


<html class="theme-next pisces use-motion">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  
  
  <link href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  
    
      
    

    
  

  

  
    
      
    

    
  

  
    
      
    

    
  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Mondax:300,300italic,400,400italic,700,700italic|Roboto Slab:300,300italic,400,400italic,700,700italic|Lobster Two:300,300italic,400,400italic,700,700italic|PT Mono:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/vendors/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.0.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="blog 架构设计 软件开发" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.0.1" />






<meta name="description" content="好好学习，天天向上">
<meta property="og:type" content="website">
<meta property="og:title" content="gglinux's blog">
<meta property="og:url" content="http://gglinux.com/index.html">
<meta property="og:site_name" content="gglinux's blog">
<meta property="og:description" content="好好学习，天天向上">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="gglinux's blog">
<meta name="twitter:description" content="好好学习，天天向上">



<script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: undefined,
      author: '博主'
    }
  };
</script>

  <title> gglinux's blog </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  



  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?3771f5899dee08d150637df249f1955b";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>








  
  
    
  

  <div class="container one-collumn sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">gglinux's blog</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle"></p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
    </ul>
  

  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/03/31/user/" itemprop="url">
                  用户系统设计
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2017-03-31T21:06:24+08:00" content="2017-03-31">
              2017-03-31
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/架构/" itemprop="url" rel="index">
                    <span itemprop="name">架构</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>用户系统，主要分为账号体系和用户信息两大类。账号体系包括，登陆验证、注册、第三方授权、以及权限管理。用户信息包括，用户地理位置、用户属性、用户设备信息、还有用户日志信息。本文会介绍用户系统的具体落地方案。</p>
<h2 id="登陆验证"><a href="#登陆验证" class="headerlink" title="登陆验证"></a>登陆验证</h2><p>在一般项目账号体系中，一般会要求支持手机、邮箱、账号、QQ、微信、微博实现登陆。后面三种方式都是基于第三方授权后，完成的身份验证。手机、邮箱、账号则是相对传统的登录方式。</p>
<p>用户身份与登录的授权方式是独立开的，即用户uid和登录方式是一对多的关系。举例来说，用户A在使用微博授权登陆后，服务端鉴别身份信息为uid=123。用户A下次使用微信登陆，服务端鉴别身份同样为uid=123。不存在同一用户A拥有多个账号信息的现象。登陆授权表设计如下。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">//用户授权表</div><div class="line">CREATE TABLE `user_auth` (</div><div class="line">  `id` bigint(20) NOT NULL AUTO_INCREMENT,</div><div class="line">  `uid` bigint(20) unsigned NOT NULL DEFAULT &apos;0&apos; COMMENT &apos;用户id&apos;,</div><div class="line">  `identity_type` tinyint(4) unsigned NOT NULL DEFAULT &apos;1&apos; COMMENT &apos;1手机号 2邮箱 3用户名 4qq 5微信 6腾讯微博 7新浪微博&apos;,</div><div class="line">  `identifier` varchar(50) NOT NULL DEFAULT &apos;&apos; COMMENT &apos;手机号 邮箱 用户名或第三方应用的唯一标识&apos;,</div><div class="line">  `certificate` varchar(20) NOT NULL DEFAULT &apos;&apos; COMMENT &apos;密码凭证(站内的保存密码，站外的不保存或保存token)&apos;,</div><div class="line">  `create_time` int(11) unsigned NOT NULL DEFAULT &apos;0&apos; COMMENT &apos;绑定时间&apos;,</div><div class="line">  `update_time` int(11) unsigned NOT NULL DEFAULT &apos;0&apos; COMMENT &apos;更新绑定时间&apos;,</div><div class="line">  PRIMARY KEY (`id`),</div><div class="line">  UNIQUE KEY `only` (`uid`,`identity_type`),</div><div class="line">  KEY `idx_uid` (`uid`) USING BTREE</div><div class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT=&apos;用户授权表&apos;</div></pre></td></tr></table></figure>
<h2 id="用户信息"><a href="#用户信息" class="headerlink" title="用户信息"></a>用户信息</h2><p>用户信息，为便于扩展，分成两类。用户基础信息和用户拓展信息。基本信息用来保存用户的基本属性，年龄、性别、生日、头像、手机号码等。扩展信息，用来保存用户的设备信息或其他可扩展的内容。另外还有位置信息，这个可独立出来，也可合并到扩展信息中，根据自己的使用场景来定。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div></pre></td><td class="code"><pre><div class="line">//用户基础信息</div><div class="line">CREATE TABLE `user_base` (</div><div class="line">  `uid` bigint(20) NOT NULL COMMENT &apos;用户ID&apos;,</div><div class="line">  `user_role` tinyint(2) unsigned NOT NULL DEFAULT &apos;2&apos; COMMENT &apos;2正常用户 3禁言用户 4虚拟用户 5运营&apos;,</div><div class="line">  `register_source` tinyint(4) unsigned NOT NULL DEFAULT &apos;0&apos; COMMENT &apos;注册来源：1手机号 2邮箱 3用户名 4qq 5微信 6腾讯微博 7新浪微博&apos;,</div><div class="line">  `user_name` varchar(32) NOT NULL DEFAULT &apos;&apos; COMMENT &apos;用户账号，必须唯一&apos;,</div><div class="line">  `nick_name` varchar(32) NOT NULL DEFAULT &apos;&apos; COMMENT &apos;用户昵称&apos;,</div><div class="line">  `gender` tinyint(1) unsigned NOT NULL DEFAULT &apos;0&apos; COMMENT &apos;用户性别 0-female 1-male&apos;,</div><div class="line">  `birthday` bigint(20) unsigned NOT NULL DEFAULT &apos;0&apos; COMMENT &apos;用户生日&apos;,</div><div class="line">  `signature` varchar(255) NOT NULL DEFAULT &apos;&apos; COMMENT &apos;用户个人签名&apos;,</div><div class="line">  `mobile` varchar(16) NOT NULL DEFAULT &apos;&apos; COMMENT &apos;手机号码(唯一)&apos;,</div><div class="line">  `mobile_bind_time` int(11) unsigned NOT NULL DEFAULT &apos;0&apos; COMMENT &apos;手机号码绑定时间&apos;,</div><div class="line">  `email` varchar(100) NOT NULL DEFAULT &apos;&apos; COMMENT &apos;邮箱(唯一)&apos;,</div><div class="line">  `email_bind_time` int(11) unsigned NOT NULL DEFAULT &apos;0&apos; COMMENT &apos;邮箱绑定时间&apos;,</div><div class="line">  `face` varchar(255) NOT NULL DEFAULT &apos;&apos; COMMENT &apos;头像&apos;,</div><div class="line">  `face200` varchar(255) NOT NULL DEFAULT &apos;&apos; COMMENT &apos;头像 200x200x80&apos;,</div><div class="line">  `srcface` varchar(255) NOT NULL DEFAULT &apos;&apos; COMMENT &apos;原图头像&apos;,</div><div class="line">  `create_time` int(11) unsigned NOT NULL COMMENT &apos;创建时间&apos;,</div><div class="line">  `update_time` int(11) unsigned NOT NULL COMMENT &apos;修改时间&apos;,</div><div class="line">  `push_token` varchar(50) NOT NULL COMMENT &apos;用户设备push_token&apos;,</div><div class="line">  PRIMARY KEY (`uid`),</div><div class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT=&apos;用户基础信息表&apos;</div><div class="line"></div><div class="line">//用户扩展信息</div><div class="line">CREATE TABLE `user_extra` (</div><div class="line">  `uid` bigint(20) NOT NULL COMMENT &apos;用户 ID&apos;,</div><div class="line">  `vendor` varchar(64) NOT NULL DEFAULT &apos;&apos; COMMENT &apos;手机厂商：apple|htc|samsung，很少用&apos;,</div><div class="line">  `client_name` varchar(50) NOT NULL DEFAULT &apos;&apos; COMMENT &apos;客户端名称，如hjskang&apos;,</div><div class="line">  `client_version` varchar(50) NOT NULL DEFAULT &apos;&apos; COMMENT &apos;客户端版本号，如7.0.1&apos;,</div><div class="line">  `os_name` varchar(16) NOT NULL DEFAULT &apos;&apos; COMMENT &apos;设备号:android|ios&apos;,</div><div class="line">  `os_version` varchar(16) NOT NULL DEFAULT &apos;&apos; COMMENT &apos;系统版本号:2.2|2.3|4.0|5.1&apos;,</div><div class="line">  `device_name` varchar(32) NOT NULL DEFAULT &apos;&apos; COMMENT &apos;设备型号，如:iphone6s、u880、u8800&apos;,</div><div class="line">  `device_id` varchar(128) NOT NULL DEFAULT &apos;&apos; COMMENT &apos;设备ID&apos;,</div><div class="line">  `idfa` varchar(50) NOT NULL DEFAULT &apos;&apos; COMMENT &apos;苹果设备的IDFA&apos;,</div><div class="line">  `idfv` varchar(50) NOT NULL DEFAULT &apos;&apos; COMMENT &apos;苹果设备的IDFV&apos;,</div><div class="line">  `market` varchar(20) NOT NULL DEFAULT &apos;&apos; COMMENT &apos;来源&apos;,</div><div class="line">  `create_time` int(11) unsigned NOT NULL DEFAULT &apos;0&apos; COMMENT &apos;添加时间&apos;,</div><div class="line">  `update_time` int(11) unsigned NOT NULL DEFAULT &apos;0&apos; COMMENT &apos;更新时间&apos;,</div><div class="line">  `extend1` varchar(100) NOT NULL DEFAULT &apos;&apos; COMMENT &apos;扩展字段1&apos;,</div><div class="line">  `extend2` varchar(100) NOT NULL DEFAULT &apos;&apos; COMMENT &apos;扩展字段2&apos;,</div><div class="line">  `extend3` varchar(100) NOT NULL DEFAULT &apos;&apos; COMMENT &apos;扩展字段3&apos;,</div><div class="line">  PRIMARY KEY (`uid`)</div><div class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT=&apos;用户额外信息表&apos;</div><div class="line"></div><div class="line">//用户位置信息</div><div class="line">CREATE TABLE `user_location` (</div><div class="line">  `uid` bigint(20) unsigned NOT NULL COMMENT &apos;用户ID&apos;,</div><div class="line">  `curr_nation` varchar(10) NOT NULL DEFAULT &apos;&apos; COMMENT &apos;所在地国&apos;,</div><div class="line">  `curr_province` varchar(10) NOT NULL DEFAULT &apos;&apos; COMMENT &apos;所在地省&apos;,</div><div class="line">  `curr_city` varchar(10) NOT NULL DEFAULT &apos;&apos; COMMENT &apos;所在地市&apos;,</div><div class="line">  `curr_district` varchar(20) NOT NULL DEFAULT &apos;&apos; COMMENT &apos;所在地地区&apos;,</div><div class="line">  `location` varchar(255) NOT NULL DEFAULT &apos;&apos; COMMENT &apos;具体地址&apos;,</div><div class="line">  `longitude` decimal(10,6) DEFAULT NULL COMMENT &apos;经度&apos;,</div><div class="line">  `latitude` decimal(10,6) DEFAULT NULL COMMENT &apos;纬度&apos;,</div><div class="line">  `update_time` int(11) unsigned DEFAULT &apos;0&apos; COMMENT &apos;修改时间&apos;,</div><div class="line">  PRIMARY KEY (`uid`)</div><div class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT=&apos;用户定位表&apos;</div></pre></td></tr></table></figure>
<h2 id="用户日志信息"><a href="#用户日志信息" class="headerlink" title="用户日志信息"></a>用户日志信息</h2><p>日志信息，用来保存用户注册或者登陆行为的。另外会有一些修改密码或者修改重要信息的日志记录。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line">//用户登陆日志</div><div class="line">CREATE TABLE `user_login_log` (</div><div class="line">  `id` bigint(20) NOT NULL AUTO_INCREMENT,</div><div class="line">  `uid` bigint(20) unsigned NOT NULL DEFAULT &apos;0&apos; COMMENT &apos;用户uid&apos;,</div><div class="line">  `type` tinyint(3) unsigned NOT NULL DEFAULT &apos;1&apos; COMMENT &apos;登录方式 第三方/邮箱/手机等&apos;,</div><div class="line">  `command` tinyint(3) unsigned NOT NULL DEFAULT &apos;1&apos; COMMENT &apos;操作类型 1登陆成功  2登出成功 3登录失败 4登出失败&apos;,</div><div class="line">  `version` varchar(32) NOT NULL DEFAULT &apos;1.0&apos; COMMENT &apos;客户端版本号&apos;,</div><div class="line">  `client` varchar(20) NOT NULL DEFAULT &apos;dabaozha&apos; COMMENT &apos;客户端&apos;,</div><div class="line">  `device_id` varchar(64) NOT NULL DEFAULT &apos;&apos; COMMENT &apos;登录时设备号&apos;,</div><div class="line">  `lastip` varchar(32) NOT NULL DEFAULT &apos;&apos; COMMENT &apos;登录ip&apos;,</div><div class="line">  `os` varchar(16) NOT NULL DEFAULT &apos;&apos; COMMENT &apos;手机系统&apos;,</div><div class="line">  `osver` varchar(32) NOT NULL DEFAULT &apos;&apos; COMMENT &apos;系统版本&apos;,</div><div class="line">  `text` varchar(200) NOT NULL DEFAULT &apos;&apos;,</div><div class="line">  `create_time` int(11) unsigned NOT NULL DEFAULT &apos;0&apos; COMMENT &apos;操作时间&apos;,</div><div class="line">  PRIMARY KEY (`id`),</div><div class="line">  KEY `idx_uid_type_time` (`uid`,`type`,`create_time`) USING BTREE,</div><div class="line">  KEY `idx_create_time` (`create_time`)</div><div class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT=&apos;登陆日志表&apos;</div><div class="line"></div><div class="line">//用户注册日志</div><div class="line">CREATE TABLE `user_register_log` (</div><div class="line">  `id` bigint(20) NOT NULL AUTO_INCREMENT COMMENT &apos;自增ID&apos;,</div><div class="line">  `uid` bigint(20) unsigned NOT NULL COMMENT &apos;用户ID&apos;,</div><div class="line">  `register_method` tinyint(2) unsigned NOT NULL COMMENT &apos;注册方式1手机号 2邮箱 3用户名 4qq 5微信 6腾讯微博 7新浪微博&apos;,</div><div class="line">  `register_time` int(11) NOT NULL COMMENT &apos;注册时间&apos;,</div><div class="line">  `register_ip` varchar(16) NOT NULL DEFAULT &apos;&apos; COMMENT &apos;注册IP&apos;,</div><div class="line">  `register_client` varchar(16) NOT NULL DEFAULT &apos;&apos; COMMENT &apos;注册客户端&apos;,</div><div class="line">  PRIMARY KEY (`id`),</div><div class="line">) ENGINE=InnoDB AUTO_INCREMENT=12 DEFAULT CHARSET=utf8mb4 COMMENT=&apos;用户注册日志表&apos;</div><div class="line"></div><div class="line">//修改信息日志</div><div class="line">CREATE TABLE `user_info_update` (</div><div class="line">  `id` bigint(20) NOT NULL AUTO_INCREMENT COMMENT &apos;自增ID&apos;,</div><div class="line">  `uid` bigint(20) unsigned NOT NULL COMMENT &apos;用户ID&apos;,</div><div class="line">  `attribute_name` varchar(30) NOT NULL COMMENT &apos;属性名&apos;,</div><div class="line">  `attribute_old_val` varchar(30) NOT NULL DEFAULT &apos;&apos; COMMENT &apos;属性对应旧的值&apos;,</div><div class="line">  `attribute_new_val` varchar(30) NOT NULL DEFAULT &apos;&apos; COMMENT &apos;属性对应新的值&apos;,</div><div class="line">  `update_time` int(11) NOT NULL COMMENT &apos;修改时间&apos;,</div><div class="line">  PRIMARY KEY (`id`),</div><div class="line">) ENGINE=InnoDB AUTO_INCREMENT=12 DEFAULT CHARSET=utf8mb4 COMMENT=&apos;用户注册日志表&apos;</div></pre></td></tr></table></figure>
<h2 id="全局uid"><a href="#全局uid" class="headerlink" title="全局uid"></a>全局uid</h2><p>建议不要使用表的主键作为用户ID，而是使用ID生成器(发号器)生成用户的唯一标示guid。当用户量急剧上升时，往往会采取分库分表的方法，然后通过将uid取余写到不同的表中。如果单纯的以某个表主键作为ID。会限制插入性能和增加业务复杂度,其次在分布式数据库中也无法保证ID唯一性。</p>
<p>全局ID生成，是有很多方案的。简单一点，可以采用redis自增属性，因为其具有原子性，在分布式坏境中，能保证ID的唯一性。另外还有其他的一些开源方案，可自行Google。</p>
<h2 id="Access-Token"><a href="#Access-Token" class="headerlink" title="Access Token"></a>Access Token</h2><p>与传统的Session相比，Access Token比较适合做RESTful Api开发。传统Web应用中，用户登陆后会写用户信息到cookie中，服务端通过Session就能得到用户的身份。</p>
<p>Access Token的是OAuth2.0中用户经过授权后，返回调用API的凭证。对于自己的应用来讲，用户在登录后，即返回access_token。在token有效期内可凭借此凭证，调用其他接口。对于access_token的刷新有两种方案，第一种每次用户重启app时，重新refresh。第二种，在调用周期内服务端发现access token可能过期时，返回新的token给客户端。</p>
<p>至于Access Token的生成，这个并没有规定，只要保证其唯一性即可。简单点，对用户uid和当前时间哈希得到新的Access Token，并设置过期时间。另外也可以采用<a href="https://jwt.io/" target="_blank" rel="external">JWT</a>实现。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/03/06/feed_design/" itemprop="url">
                  Feed系统设计
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2017-03-06T21:06:24+08:00" content="2017-03-06">
              2017-03-06
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/架构/" itemprop="url" rel="index">
                    <span itemprop="name">架构</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>Feed，在社交和信息推荐的App与网站中，基本都会用到的。例如常用的新浪微博，用户登录进入后，展现给我们的就是feed信息流。新浪微博的信息，来自于你关注人所发布的内容。还有微信的朋友圈，今日头条的信息流，好友发布的美拍等，这些都是Feed。玩过知乎的人应该知道，在知乎Feed中，会显示某某关注了某某话题，某某点赞或者赞同了某个回答。广义来讲，这些也算是一种Feed。</p>
<p>本文会先介绍几种不同的Feed设计，让大家对Feed实现有初步的了解。其次会对我们采用的Feed方案作出详细的解答。</p>
<h2 id="推方式"><a href="#推方式" class="headerlink" title="推方式"></a>推方式</h2><p>推方式，是发生在用户触发行为（发布新的动态，关注某个人，点赞）的时候。在触发时，用户的自身行为会记录到对应的行为表中，其次用户的行为也会记录到自己的粉丝对应动态表中。<br><img src="http://img.blog.csdn.net/20170307135925176?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvZ2dsaW51eA==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述"></p>
<ol>
<li>用户A发布新的帖子（动态），帖子记录到帖子表（主表）中。</li>
<li>发帖行为塞到队列（Redis List）中。触发异步操作，消费者会先读取用户的粉丝列表（uid分表），依次写入到用户的动态表（uid分表）中。</li>
<li>前端读取用户动态Feed，使用过滤条件，读取用户的动态表（关联查询帖子表）。</li>
</ol>
<p>使用推方式，对需求变更是易适应的。为什么这么说呢？因为用户每一次的行为，我们都有存储相应的数据（数据模型）。即使变更，只需更改逻辑层代码。另外性能较好，后台数据已经准备好了，无需复杂的SQL查询。当然这样做，也存在很多弊端。1. 如果在用户A发完动态后，其粉丝B取消关注了A。在这个时间差内，内容已经推送给粉丝B了。2. 数据量存储成本较大，假如一个用户的粉丝数是100万，在发帖后会写入100万条数据。</p>
<h2 id="拉方式"><a href="#拉方式" class="headerlink" title="拉方式"></a>拉方式</h2><p>拉方式，是发生在粉丝拉取Feed时。粉丝拉取自己的动态，首先会检索自己的关注用户（uid分表）。得到关注的uid之后，再根据uid去查询关注用户发布的帖子。<br><img src="http://img.blog.csdn.net/20170307140259056?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvZ2dsaW51eA==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述"></p>
<p>拉的模式相对是比较简单易实现的，另外对用户关系变更（新增，删除用户）是敏感的。其次也不存在数据存储压力。但在查询的时候，对帖子表本身压力是很大的。尤其是用户本身关注的人很多的话，会有很严重的性能问题。</p>
<h2 id="拉方式优化-伪实时拉取"><a href="#拉方式优化-伪实时拉取" class="headerlink" title="拉方式优化-伪实时拉取"></a>拉方式优化-伪实时拉取</h2><p>用户在登录APP时，会发送用户活跃态到服务端。活跃信号塞到队列中，消费者依次读取活跃态uid，得到用户的关注者列表。得到关注者列表后，会去帖子表，查询关注人的发布的帖子。写到用户自己的Feed中。<br><img src="http://img.blog.csdn.net/20170307141232300?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvZ2dsaW51eA==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述"></p>
<p>这种方式和对拉方式而言，能有效避免接口性能问题，相当于通过定时任务提前把用户的动态Feed跑出来。和推方式比较，推是比较盲目的，这种方式只需针对活跃用户即可，能避免存储浪费。缺点在于实时性不好，用户登录APP后马上进入自己的Feed页，此时如果后台用户动态还没跑完，接口读取的就是历史数据了。当然这种方式不适合知乎，微博这种类型的APP的。</p>
<h2 id="拉方式优化-分区拉取"><a href="#拉方式优化-分区拉取" class="headerlink" title="拉方式优化-分区拉取"></a>拉方式优化-分区拉取</h2><p>分区拉取，是为了避免频繁查询单一帖子表所采用的一种优化手段。通过对帖子按照时间片分表，每次查询都能均摊到不同的表中，以此减轻主表的压力。</p>
<h2 id="推方式优化-定时推"><a href="#推方式优化-定时推" class="headerlink" title="推方式优化-定时推"></a>推方式优化-定时推</h2><p>定时推，是以常驻进程的方式读取用户的发帖行为，再批量写入到粉丝的动态表中。这种方式和推方式差不多，只不过可以对多个发帖行为做聚合。</p>
<h2 id="推方式优化-特定用户推"><a href="#推方式优化-特定用户推" class="headerlink" title="推方式优化-特定用户推"></a>推方式优化-特定用户推</h2><p>特定用户推，是推方式的一种优化方法。用户发送帖子时，只对活跃的粉丝用户写入。当然活跃用户的判定策略，是需要商定的。</p>
<h2 id="综合"><a href="#综合" class="headerlink" title="综合"></a>综合</h2><p>以上几种方案，都有自己的利弊和适用场景。选择最适合自己的就是最好的。最后，我们采用了伪实时拉取这种方式。因为我们的需求是对点赞用户的聚合展示，类似于下图知乎这种。<br><img src="http://img.blog.csdn.net/20170307140332780?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvZ2dsaW51eA==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述"></p>
<p>本身点赞行为会存储在两种类型的表（以帖子ID的点赞分表，以用户ID的点赞分表）中，如果单纯以拉方式话，会比较难处理的，而且有性能问题。其次，点赞这个行为的重要程度还不足以我们批量去存储的。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/02/26/app_optimize/" itemprop="url">
                  App首屏接口性能优化
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2017-02-26T21:06:24+08:00" content="2017-02-26">
              2017-02-26
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/架构/" itemprop="url" rel="index">
                    <span itemprop="name">架构</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>目前所在项目组开发的是一款母婴产品，集工具和社区属性。截止本文发布，注册用户接近7000万，首屏接口日访问量过百万。在首屏中，会给用户展现不同的数据，比如每日任务，宝宝（婴儿）每日概述，胎教音乐，运动视频，热帖等模块。首屏接口性能的好坏，将直接影响到app的使用体验。</p>
<p>我们服务端RPC框架采用RESTful，其底层是curl实现的。curl采用http协议的，另外我们服务端的技术栈是PHP。我们都知道http协议相比较TCP而言，不仅多了http的报头，PHP本身性能也是大问题。在不做大重构的情况下，怎么做最小的修改，完成最大的性能提高。还是很有挑战性的。</p>
<p>针对首屏接口，我们针对其完成了两次性能优化。</p>
<h2 id="分屏加载"><a href="#分屏加载" class="headerlink" title="分屏加载"></a>分屏加载</h2><p>将本来属于一个接口的内容，单独在两个请求中返回。第一屏API返回关键的数据，减少用户初次进入的等待时间。第二屏，返回剩余的大部分数据。具体API返回内容的划分，是依赖客户端渲染顺序的。也没绝对标准。但我们的原则是，第一屏API力所能及返回最少的数据，避免用户等待。剩余的留给第二屏的API去完成。分屏加载的难点有以下几个。</p>
<ol>
<li>确定好数据加载顺序，最基础的数据肯定是需要最先返回的，另外也要客户端的同学配合。 </li>
<li>首屏内容是和用户的怀孕状态紧密联系在一起的，用户切换宝宝(怀孕中切换到宝宝已出生，宝宝A切换到宝宝B)时，API的刷新频率怎么控制。最后为了可操作性，采用了比较粗暴的做法，每次切换均会请求两次接口。</li>
</ol>
<p>完成分屏加载以后，用户进入首页的等待时间，已经由2-3S减为1S左右。不必像以前客户端拿到全部内容后，才去渲染界面。现在只需要拿到第一屏的接口，即可完成界面的渲染工作。<br>分屏后第一屏接口耗时<br><img src="http://img.blog.csdn.net/20170226153007559?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvZ2dsaW51eA==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述"><br>分屏后第二屏接口耗时<br><img src="http://img.blog.csdn.net/20170226153030013?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvZ2dsaW51eA==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述"></p>
<h2 id="xhprof性能分析"><a href="#xhprof性能分析" class="headerlink" title="xhprof性能分析"></a>xhprof性能分析</h2><p>通过在alpha坏境和beta坏境部署Xhprof性能分析工具。我们可以看到实际的API在函数级别的性能损耗。这里不详述该工具的部署方式和使用方法。在Xhprof的帮助下，我们得到了以下几个结论。</p>
<ol>
<li>RPC采用的是HTTP协议，单纯的RPC调用便接近10MS的耗时。首屏RPC调用次数接近30次。</li>
<li>每个RPC服务层内部，通过函数调用即可，也采用RPC的方式。</li>
<li>热点数据直接查库，缓存利用率低下。</li>
<li>数据表索引乱用，存在慢查询。</li>
</ol>
<p>结合上面几点，在实际操作过程中，由简到难，逐步完成。第一能减少RPC，便减少RPC请求。逻辑层数据由以前的多次获取改为一次获取。其次，服务层内部，不垮服务层不走RPC，直接以函数调用的方式请求。第三，热点不变动的数据，直接在逻辑层缓存，拿到后丢给API返回。第四，追踪MYSQL慢查询，优化查询SQL。完成后，第一屏性能提升30%～50%。第二屏提升40%～60%。实际结果可看下图</p>
<p>第二次优化第一屏接口耗时<br><img src="http://img.blog.csdn.net/20170226153342986?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvZ2dsaW51eA==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="第一屏接口"></p>
<p>第二次优化第二屏接口耗时<br><img src="http://img.blog.csdn.net/20170226153405311?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvZ2dsaW51eA==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="第二屏接口"></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/02/07/innoDB1/" itemprop="url">
                  InnoDB存储引擎（一）
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2017-02-07T21:06:24+08:00" content="2017-02-07">
              2017-02-07
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/MySQL/" itemprop="url" rel="index">
                    <span itemprop="name">MySQL</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="InnoDB存储引擎（一）"><a href="#InnoDB存储引擎（一）" class="headerlink" title="InnoDB存储引擎（一）"></a>InnoDB存储引擎（一）</h2><h3 id="整体结构"><a href="#整体结构" class="headerlink" title="整体结构"></a>整体结构</h3><p><img src="http://img.blog.csdn.net/20170207195627096?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvZ2dsaW51eA==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述"></p>
<h3 id="内存池"><a href="#内存池" class="headerlink" title="内存池"></a>内存池</h3><ol>
<li>维护线程／进程内部数据结构</li>
<li>缓存磁盘文件（cache）</li>
<li>对数据的更新或者新增操作，避免直接刷新磁盘</li>
<li>重做日志缓冲（redo log）<br><img src="http://img.blog.csdn.net/20170207195648874?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvZ2dsaW51eA==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述"></li>
</ol>
<h3 id="后台线程"><a href="#后台线程" class="headerlink" title="后台线程"></a>后台线程</h3><ol>
<li>Master Hhread，将更新的数据（包括新增和被修改的数据）异步刷新到磁盘，维护内存池和磁盘中的数据的一致性。</li>
<li>IO Thread分为Insert buffer Thread,log thread,read thread,write thread。</li>
<li>purge thread，回收undo log</li>
<li>Page cleaner thread，刷新脏页到磁盘（由master thread 独立出来的）<br><img src="http://img.blog.csdn.net/20170207201334791?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvZ2dsaW51eA==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述"></li>
</ol>
<p>Write Ahead log:是指当事务提交上，先做重做日志，再修改页。满足事务中持久性要求。</p>
<p>Check Point：检查点技术，数据库系统为了缩短数据库发生宕机恢复所需的时间所采取的一种刷新脏页的方法。    检查点技术分为两种，sharp checkpoint和fuzzy checkpoint。sharp checkpoint用在数据库关机时，将所有的脏数据全部刷新到磁盘。fuzzy checkpoint是按照一定的策略定时部分的刷新脏页数据，较为复杂，此处不做介绍。</p>
<h3 id="InnoDB关键特性"><a href="#InnoDB关键特性" class="headerlink" title="InnoDB关键特性"></a>InnoDB关键特性</h3><ol>
<li>插入缓冲（性能提升）<ul>
<li>Insert Buffer 当新增数据并且存在非聚焦索引时，会有对非聚焦索引页的离散读。当出现这种情况时，mysql会先判断当前的非聚焦索引页是否存在于缓冲池中，如果存在则直接修改或者新增。如果不存在缓冲池中，则会先放到缓冲池中（类似于脏页），再以一定的频率merge之后，插入到实际的非聚焦索引页。</li>
<li>Change Buffer 插入缓冲的升级，用在删除或者更新的情况下。在删除时，并不会对非聚焦索引全部删除。在更新是，也不马上更新非聚焦索引。</li>
<li>以上两种优化手段，适用于 1. 存在非聚焦索引 2. 非聚焦索引不唯一。</li>
</ul>
</li>
<li>两次写（可靠性）<ul>
<li>对某页写回磁盘的过程中，如果出现宕机，并且导致页破坏（无法使用重做日志）。会出现数据丢失的情况。针对此问题，mysql首先会将所有需要写入的页（2MB）全部刷回到共享表空间中（没有离散写），再将更新的数据写入到各自的表空间中。<br><img src="http://img.blog.csdn.net/20170207195837984?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvZ2dsaW51eA==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述"></li>
</ul>
</li>
<li>自适应哈希索引（性能提升）<ul>
<li>InnoDB查找耗时主要在于B+树的查找，通过使用哈希这种数据结构，将查询参数（Key）和值（位置）对应来减少查找的耗时。</li>
</ul>
</li>
<li>异步IO（性能提升）<ul>
<li>异步IO在对磁盘进行写入时，是非阻塞式的，能对多个查询或者插入操作进行merge，以减少实际的IO次数。</li>
</ul>
</li>
<li>刷新邻接页（性能提升）<ul>
<li>在刷新脏页时，会检查该页所在所在区的所有页，连同刷新。</li>
</ul>
</li>
</ol>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/01/08/about2016/" itemprop="url">
                  About 2016
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2017-01-08T21:37:23+08:00" content="2017-01-08">
              2017-01-08
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/生活/" itemprop="url" rel="index">
                    <span itemprop="name">生活</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>很久没安静下来写点什么了，太懶了。</p>
<h2 id="Review-Plan"><a href="#Review-Plan" class="headerlink" title="Review Plan"></a>Review Plan</h2><h3 id="学习"><a href="#学习" class="headerlink" title="学习"></a>学习</h3><p>去年计划看一些底层的书籍，基本都完成了。书单是</p>
<ol>
<li>redis设计与实现 100%</li>
<li>mysql技术内幕 100%</li>
<li>深入理解nginx 11%</li>
<li>nginx实战开发 100%</li>
<li>大型网站技术架构 100%</li>
<li>Hadoop实战 70%</li>
<li>微服务设计 21%</li>
<li>激荡三十年 14%</li>
<li>利用python进行数据分析 8%</li>
</ol>
<p>设计模式，架构这块内容，2016年接触的还是蛮少。</p>
<h3 id="工作"><a href="#工作" class="headerlink" title="工作"></a>工作</h3><p>5月份从美图离职，来到了喜欢的城市-深圳，也正把户口迁过来。以前，在厦门这座安逸的城市，反而有一些压力。但在深圳，感觉工作按部就班，有种温水煮青蛙之感。</p>
<p>一直说分享有三个层次。第一层次，写博客。第二层次，分享给他人。第三层次，给大众演讲。2016年在技术上做了第一次分享，效果自己还是挺满意的。</p>
<p>经历两次实习和半年的工作，由初入职场的菜鸟，逐渐变成了现在的团队核心。这个也蛮欣慰。在工作以前，一直坚信，技术乃技术人的立身之本。真正工作以后，反而觉得技术只是工作的一部分。沟通能力，团队协调能力，责任心，产品理解能力。这些综合素质，在团队里面更重要。在与其他人沟通的过程中，自己很急躁，说话很快。</p>
<h3 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h3><p>一直计划每年去一个地方，今年在厦门待了两个月，去了香港。唯一的遗憾，7天的国庆假期，没有好好利用。另外，国庆期间也发生了一件对我影响很大的事情。</p>
<p>技术上，虽然看了一些书，但与我期望的还有很大的差距。GitHub后半年基本没更新了。博客也久未更新，简直浪费当年的精力。真正的大牛，应该是理论和实践相结合的。</p>
<p>感情上，不知道怎么说。可能自己是很随和的人，感情很被动。真正的爱情，每个个体精神上既相互慰藉也是相互独立的。与女朋友的时间分配上，希望有所改变。</p>
<p>健身，从大学想到了现在。依旧没能真正执行。公司每周三的篮球，也经常缺席。虽然现在工作强度不大，但想想以后，还是要多锻炼。</p>
<p>厨艺上，很是骄傲的，后面这段时间，有空就是自己做饭吃。野外生存，至少不会饿肚子了。</p>
<h2 id="Preview-Plan"><a href="#Preview-Plan" class="headerlink" title="Preview Plan"></a>Preview Plan</h2><h3 id="学习-1"><a href="#学习-1" class="headerlink" title="学习"></a>学习</h3><p>今年想看些架构和思维方面的书籍，暂时先列出以下这些。想到再加。</p>
<ol>
<li>微服务设计</li>
<li>设计模式之禅</li>
<li>软技能-代码之外的生存指南</li>
<li>python-codebook</li>
<li>高效程序员的45个习惯</li>
<li>激荡三十年</li>
<li>Docker——容器与容器云</li>
</ol>
<h3 id="工作-1"><a href="#工作-1" class="headerlink" title="工作"></a>工作</h3><p>目前在做业务开发，技术上没难点，主要提升下综合能力。沟通时，思考之后再说，慢一点。其次，对产品也要有自己的判断能力，学会反驳。明年，希望能转岗到架构组。</p>
<h3 id="其他-1"><a href="#其他-1" class="headerlink" title="其他"></a>其他</h3><p>去年的计划完成的挺不错的，虽然计划的内容比较少。今年继续加油！</p>
<ol>
<li>2017年计划去趟国外，任何一个国家都可以，或者去趟西藏或者新疆。</li>
<li>技术上，GitHub不做具体的要求。博客，一个月至少两篇。还是要有点强制的好。</li>
<li>感情上，做的不好的地方，会改正。精神上还是需要独立一些。</li>
<li>学会理财，每月整理自己的账单，坚持一年。</li>
<li>健身，每周三固定打球时间，坚持一年。</li>
<li>学习外语。空闲时间记单词，坚持用英文查资料。</li>
</ol>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/04/10/short_video&dev/" itemprop="url">
                  短视频和技术
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-04-10T21:06:24+08:00" content="2016-04-10">
              2016-04-10
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/生活/" itemprop="url" rel="index">
                    <span itemprop="name">生活</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p> 在美图有一段时间了。从两方面总结下。下段时间，继续努力！</p>
<h2 id="对短视频的理解"><a href="#对短视频的理解" class="headerlink" title="对短视频的理解"></a>对短视频的理解</h2><p>近两年因为4G的普及，手机拍摄技术的改善。传统的媒介方式，由文字到语音，再到图片，再转到了视频。现在看来短视频的火爆，也是很正常的。秒拍，快手，美拍，包括腾讯的微视，这几款平台型的短视频应用都发展的挺不错的。秒拍背后有新浪爸爸。美拍背后依靠超级app美图秀秀。快手，由做gif出身，生的早。根据公开数据显示，美拍目前的平均日活是450万。最近的papi酱，和二更则针对内容型，类似于美拍里面的达人，用于产生内容。</p>
<p>下面着重说下美拍，从产品角度看。美拍很像淘宝，达人雷同于高级旗舰店铺，普通人则类比普通商家。达人，是主要的内容创造者，都想建立自己的品牌。目前的话，美拍在做淘宝之前的事情，免费服务商家和用户。后期要怎么发展了？也可以参考淘宝现在的模式，但是视频内容比较缺乏商品属性。用户不会有太多的消费欲望。这个也可以参考知乎和微信公众号和简书一类的，通过打赏机制一方面鼓励内容生产者－达人，另外平台本身也收取一定分成。所以美拍现阶段的产品重点是挖掘达人，制造优质内容。</p>
<p>从技术角度分析的话，美拍又与新浪微博选型非常像。包含话题，排行榜，评论，点赞，附近的人，个人主页，私信。又是一个社交体系。</p>
<h2 id="对技术的理解"><a href="#对技术的理解" class="headerlink" title="对技术的理解"></a>对技术的理解</h2><p>美拍的用户量，已经达到一定量级了，平均日活450万。对系统架构很有挑战性的。因为自己平时主要做的是业务性的，架构方面了解的不是很多。就简单说下几点想法。第一个，项目代码的糟糕程度和接手人的适应速度正相关。第二个，写代码的时候考虑未来性的东西要深一点。第三个，业务模块化，应用分层化。第四个，国内大部分技术都是业务驱动的。第五个，开发也要善于表现自己，对需求的沟通能力很重要。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2015/12/20/redis2/" itemprop="url">
                  Redis数据结构（二）
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2015-12-20T21:06:24+08:00" content="2015-12-20">
              2015-12-20
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Redis/" itemprop="url" rel="index">
                    <span itemprop="name">Redis</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="压缩列表"><a href="#压缩列表" class="headerlink" title="压缩列表"></a>压缩列表</h2><p>1：压缩列表是为了节省内存而设计的，是一种线性的数据结构。主要用在哈希和列表两种数据类型中。</p>
<p>2：压缩列表包含主要包含五个部分，这五个部分顺序排列组合在一起。<br>结构如下图所示。<br><img src="http://img.blog.csdn.net/20160103164255998" alt="这里写图片描述"><br>表节点，有三个域组成。previous_entry_length,用来记录前一个节点的长度。encoding,记录下一个域的数据类型和长度。content,保存节点的值。<br><img src="http://img.blog.csdn.net/20160103164913156" alt="这里写图片描述"></p>
<p>3：压缩列表有一种极端情况，会导致性能下降——连锁更新。previous_entry_length,记录的是上一节点的长度，当上一节点小于254字节时，该属性使用1字节存储。当大于254字节时，使用5字节。如果之前previous_entry_length都使用1字节，且长度都接近254字节时，会导致连锁更新的情况。</p>
<h2 id="具体使用情况"><a href="#具体使用情况" class="headerlink" title="具体使用情况"></a>具体使用情况</h2><p>1：不同数据类型对应的编码对象<br><img src="http://img.blog.csdn.net/20160103172033023" alt="这里写图片描述"></p>
<p>2：字符串对应的编码方式。1：整数值实现的字符串对象。2：embstr实现的字符串（类似SDS，用于保存端的字符串）。3：raw,SDS动态字符串<br><img src="http://img.blog.csdn.net/20160103173412166" alt="这里写图片描述"><br>转换规则：<br><img src="http://img.blog.csdn.net/20160103173455306" alt="这里写图片描述"></p>
<p>3：列表对象，编码包含两种，ziplist(压缩列表),linkedlist(双向链表)。<br><img src="http://img.blog.csdn.net/20160103173649064" alt="这里写图片描述"><br>转换规则：<br>1：保存的所有字符串长度都小于64字节。<br>2：列表对象保存的元素数量小于512个。<br>当同时满足上面两条规则时，使用列表对象，否则使用链表对象。</p>
<p>4：哈希对象，使用ziplist和hashtable编码<br>ziplist:<br><img src="http://img.blog.csdn.net/20160103174101939" alt="这里写图片描述"><br>hashtable:<br><img src="http://img.blog.csdn.net/20160103174151083" alt="这里写图片描述"><br>转换规则：<br>1：哈希对象保存的所有键和值的字符串长度都小于64字节。<br>2：保存的键值对数量小于512个。<br>同时满足，使用ziplist，否则使用hashtable.</p>
<p>5:集合对象，使用intset或者hashtable编码。<br>intset:<br><img src="http://img.blog.csdn.net/20160103174706713" alt="这里写图片描述"><br>hashtable:<br><img src="http://img.blog.csdn.net/20160103174721415" alt="这里写图片描述"><br>转换规则：<br>1：集合对象保存的元素值都是整数。<br>2：集合对象保存的元素数量不超过512个。<br>同时满足上面两个条件，则使用intset，否则hashtable。</p>
<p>6：有序集合，使用ziplist或者skiplist<br><img src="http://img.blog.csdn.net/20160103175034253" alt="这里写图片描述"><br>转换规则：<br>1：有序集合保存的元素数量小于128个。<br>2：保存的所有成员长度都小于64字节。<br>同时满足上面两个条件，则使用ziplist，否则skiplist。</p>
<p>基于数据结构的东西就写这么多吧，当然内容都是《redis设计与实现-黄健宏》上的。我只是个搬运工，这本书写的挺不错的，建议购买。更详细的实现细节，可以看redis源码。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2015/12/19/redis1/" itemprop="url">
                  Redis数据结构（一）
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2015-12-19T21:06:24+08:00" content="2015-12-19">
              2015-12-19
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Redis/" itemprop="url" rel="index">
                    <span itemprop="name">Redis</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="SDS简单动态字符串"><a href="#SDS简单动态字符串" class="headerlink" title="SDS简单动态字符串"></a>SDS简单动态字符串</h2><h3 id="结构："><a href="#结构：" class="headerlink" title="结构："></a>结构：</h3><p>1：SDS是在C语言字符串的基础上，构造的一种简单的动态字符串（simple daynamic string）。SDS结构体包含三个变量，len用来记录长度，free用来记录未使用字节的数量，buf存储实际的字符串数组。<br>2：SDS不以‘\0’为结束符，而是以len的长度标识<br><img src="http://img.blog.csdn.net/20151219142351721" alt="这里写图片描述"></p>
<h3 id="优点"><a href="#优点" class="headerlink" title="优点"></a>优点</h3><p>1：O(1)获取字符串长度。sdshdr结构体中，直接存储了字符串的长度。因此直接以sdshdr.len读取字符串长度就可以了，相对于C语言的遍历。<br>2：防止缓冲区溢出。因为sds自动记录了字符串的长度，当需要扩充某个字符串时，会先检测长度是否满足。不满足，会先扩充sdshdr.buf的长度。而C语言，strcat会直接拼接两个string，后面的string可能会占用已经占用的内存区域。<br>3：减少字符串改变带来的内存重分配次数。简单一点说，当扩充字符串时，sds会给它多分配一些额外的内存。当缩减字符串时，并没有立即将其归回，而是用sdshdr.free记录。<br>4：二进制安全。直白点，就是不以’\0’为结束符，而是记录其二进制数据，即’\0’对应的00000000。结束是以sdshdr.len来标识的<br>5：可以重用部分C语言的函数。但因为结束机制不一样，也只是部分而已。</p>
<h3 id="用处"><a href="#用处" class="headerlink" title="用处"></a>用处</h3><p>1：redis中常见的字符串值都是用sds实现的。例如，常用的键。</p>
<h2 id="双向链表"><a href="#双向链表" class="headerlink" title="双向链表"></a>双向链表</h2><h3 id="结构"><a href="#结构" class="headerlink" title="结构"></a>结构</h3><p>1：节点（struct ListNode），包含前节点和后置节点两个指针域。<br>      链表(struct List)，包含头，尾节点。以及相关的操作函数。<br>      <img src="http://img.blog.csdn.net/20151219153132066" alt="这里写图片描述">    </p>
<p><img src="http://img.blog.csdn.net/20151219153151562" alt="这里写图片描述"></p>
<p>###优点<br>1：新增和删除元素非常方便。很大部分来自链表的优点<br>2：其中的value字段，可以用来存储其他的类型，非常方便扩展</p>
<h3 id="用处-1"><a href="#用处-1" class="headerlink" title="用处"></a>用处</h3><p>1：redis中List数据类型就是用这个实现的</p>
<h2 id="字典"><a href="#字典" class="headerlink" title="字典"></a>字典</h2><h3 id="结构-1"><a href="#结构-1" class="headerlink" title="结构"></a>结构</h3><p>1：首先说明下，字典也是由其他的数据结构构造的。它包括，哈希节点，哈希表，字典三个部分。哈希表连接哈希节点，字典包含两个哈希表。<br>2：哈希节点，包含三个域。键，值，下个节点的指针。其中下个节点是为解决哈希冲突的。<br><img src="http://img.blog.csdn.net/20151219155529547" alt="这里写图片描述"><br>3：哈希表，包含四个域。dictht.table，是一个数组，对应的值就是哈希表节点。dictht.size，总大小。sizemask，用来计算索引值。used，记录已经使用多少。<br><img src="http://img.blog.csdn.net/20151219155858470" alt="这里写图片描述"><br>4：字典，包含四个域。其中，ht就是指向上面的哈希表的。<br><img src="http://img.blog.csdn.net/20151219160055049" alt="这里写图片描述"><br>5：完整的结构，未进行rehash，存在冲突。<br><img src="http://img.blog.csdn.net/20151219160222520" alt="这里写图片描述"></p>
<h3 id="优点-1"><a href="#优点-1" class="headerlink" title="优点"></a>优点</h3><p>1：有效解决了哈希冲突，通过dictEntry的next指针，将具有同一索引的值链接起来。<br>2：很方便就行rehash。我们知道到哈希表大小不足时，就很容易造成哈希冲突。此时便需要扩容。dict.ht[2]其中一个就是用来扩容的，当dictht.size == used时，便将dict.ht[1]扩大到used*2，再将dict.ht[0]缓慢哈希到dict.ht[1]。完成后，将dict.ht[0]指向dict.ht[1]，将dict.ht[1]置为空即可。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  


          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel  sidebar-panel-active ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/dog.png"
               alt="gglinux" />
          <p class="site-author-name" itemprop="name">gglinux</p>
          <p class="site-description motion-element" itemprop="description">好好学习，天天向上</p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">8</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          
            <div class="site-state-item site-state-categories">
              <a href="/categories">
                <span class="site-state-item-count">4</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">7</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/gglinux" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://weibo.com/gglinuxgjw" target="_blank" title="Weibo">
                  
                    <i class="fa fa-fw fa-weibo"></i>
                  
                  Weibo
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://www.zhihu.com/people/gglinux" target="_blank" title="ZhiHu">
                  
                    <i class="fa fa-fw fa-globe"></i>
                  
                  ZhiHu
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://twitter.com/gglinux" target="_blank" title="Twitter">
                  
                    <i class="fa fa-fw fa-twitter"></i>
                  
                  Twitter
                </a>
              </span>
            
          
        </div>

        
        

        
        

      </section>

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">gglinux</span>
</div>

<div class="powered-by">
  由 <a class="theme-link" href="http://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Pisces
  </a>
</div>

        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  
  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/vendors/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.0.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.0.1"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.0.1"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.0.1"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.0.1"></script>



  



  



  
  
  

  

  

</body>
</html>
